#!/bin/bash
# Interactive Port Forwarding Manager with TUI (bash 3.2 compatible)

# ì–¸ì–´ ë©”ì‹œì§€ ë¡œë“œ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lang-messages.sh"

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ì„¤ì • íŒŒì¼
SERVICES_FILE="$HOME/.k8s-port-forward-services.list"
PID_FILE="/tmp/k8s-port-forward.pids"
LOG_DIR="/tmp/k8s-port-forward-logs"

mkdir -p "$LOG_DIR"

# ì„œë¹„ìŠ¤ íŒŒì¼ ì´ˆê¸°í™”
[ ! -f "$SERVICES_FILE" ] && touch "$SERVICES_FILE"

# gum ì„¤ì¹˜ í™•ì¸
check_gum() {
  if ! command -v gum &> /dev/null; then
    echo -e "${YELLOW}$(msg gum_not_installed)${NC}"
    echo ""
    echo "$(msg install_method)"
    echo "  brew install gum"
    echo ""
    echo -n "$(msg install_now)"
    read -r answer
    if [[ "$answer" == "y" ]]; then
      brew install gum
    else
      echo "$(msg fallback_mode)"
      return 1
    fi
  fi
  return 0
}

# ì„œë¹„ìŠ¤ ì¶”ê°€
add_service() {
  local name=$1
  local namespace=$2
  local local_port=$3
  local remote_port=$4

  # ì¤‘ë³µ ì²´í¬
  if grep -q "^${name}|" "$SERVICES_FILE" 2>/dev/null; then
    return 1
  fi

  echo "${name}|${namespace}|${local_port}|${remote_port}" >> "$SERVICES_FILE"
  return 0
}

# ì„œë¹„ìŠ¤ ì‚­ì œ
delete_service() {
  local name=$1
  grep -v "^${name}|" "$SERVICES_FILE" > "${SERVICES_FILE}.tmp" 2>/dev/null
  mv "${SERVICES_FILE}.tmp" "$SERVICES_FILE"
}

# ì„œë¹„ìŠ¤ ì¡°íšŒ
get_service() {
  local name=$1
  grep "^${name}|" "$SERVICES_FILE" 2>/dev/null
}

# ì„œë¹„ìŠ¤ ìˆ˜ì •
update_service() {
  local name=$1
  local namespace=$2
  local local_port=$3
  local remote_port=$4

  delete_service "$name"
  add_service "$name" "$namespace" "$local_port" "$remote_port"
}

# ëª¨ë“  ì„œë¹„ìŠ¤ ëª©ë¡
list_services() {
  cat "$SERVICES_FILE" 2>/dev/null
}

# ì„œë¹„ìŠ¤ ê°œìˆ˜
count_services() {
  if [ -f "$SERVICES_FILE" ]; then
    wc -l < "$SERVICES_FILE" | tr -d ' '
  else
    echo "0"
  fi
}

# ê¸°ì¡´ í¬íŠ¸ í¬ì›Œë”© ì •ë¦¬
cleanup() {
  if [ -f "$PID_FILE" ]; then
    while read pid; do
      kill $pid 2>/dev/null
    done < "$PID_FILE"
    rm "$PID_FILE"
  fi
  pkill -f "kubectl port-forward" 2>/dev/null
}

# ë‹¨ì¼ ì„œë¹„ìŠ¤ í¬íŠ¸ í¬ì›Œë”© (ì¬ì—°ê²° ê¸°ëŠ¥)
forward_service() {
  local service=$1
  local namespace=$2
  local local_port=$3
  local remote_port=$4

  while true; do
    kubectl port-forward -n $namespace svc/$service $local_port:$remote_port \
      >> "$LOG_DIR/${service}.log" 2>&1
    sleep 3
  done
}

# ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸ í¬ì›Œë”© ìƒíƒœ í™•ì¸
get_running_services() {
  local running=0
  if [ -f "$PID_FILE" ]; then
    while read pid; do
      if ps -p $pid > /dev/null 2>&1; then
        running=$((running + 1))
      fi
    done < "$PID_FILE"
  fi
  echo "$running"
}

# ì„ íƒëœ ì„œë¹„ìŠ¤ë“¤ ì‹œì‘
start_selected_services() {
  cleanup

  echo -e "${GREEN}$(msg starting)${NC}"
  echo ""

  local IFS=$'\n'
  for line in $@; do
    local name=$(echo "$line" | cut -d'|' -f1)
    local namespace=$(echo "$line" | cut -d'|' -f2)
    local local_port=$(echo "$line" | cut -d'|' -f3)
    local remote_port=$(echo "$line" | cut -d'|' -f4)

    echo "  â–¸ $name -> localhost:$local_port"
    forward_service "$name" "$namespace" "$local_port" "$remote_port" &
    echo $! >> "$PID_FILE"
  done

  echo ""
  echo -e "${GREEN}$(msg started)${NC}"
  echo ""
  echo "$(msg running_background)"
  echo "$(msg stop_cmd) $0 stop"
}

# gum UI ëª¨ë“œ
gum_ui() {
  while true; do
    clear
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    printf "${BLUE}â•‘   %-36s  â•‘${NC}\n" "$(msg header_title)"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    local running_count=$(get_running_services)
    if [ "$running_count" -gt 0 ]; then
      echo -e "${GREEN}$(msg running_services) $running_count $(msg services_count)${NC}"
    else
      echo -e "${YELLOW}$(msg no_services)${NC}"
    fi
    echo ""

    ACTION=$(gum choose \
      "$(msg menu_start)" \
      "$(msg menu_stop)" \
      "$(msg menu_status)" \
      "$(msg menu_list)" \
      "$(msg menu_manage)" \
      "$(msg menu_logs)" \
      "$(msg menu_exit)")

    # ë©”ë‰´ ì„ íƒì— ë”°ë¼ ì²˜ë¦¬ (ì´ëª¨ì§€ê°€ í¬í•¨ë˜ì–´ ìˆì–´ íŒ¨í„´ ë§¤ì¹­ ì‚¬ìš©)
    if [[ "$ACTION" == *"$(msg menu_start)"* ]] || [[ "$ACTION" == "ğŸš€"* ]]; then
        local service_count=$(count_services)

        if [ "$service_count" -eq 0 ]; then
          echo ""
          echo -e "${YELLOW}$(msg registered_services)${NC}"
          echo ""
          echo "$(msg press_enter)"
          read
          continue
        fi

        echo ""
        echo "$(msg select_services)"
        echo ""

        local service_options=()
        while IFS='|' read -r name namespace local_port remote_port; do
          service_options+=("$name (localhost:$local_port)")
        done < "$SERVICES_FILE"

        local selected=$(gum choose --no-limit "${service_options[@]}")

        if [ -n "$selected" ]; then
          local selected_lines=""

          echo "$selected" | while IFS= read -r line; do
            local svc_name=$(echo "$line" | cut -d' ' -f1)
            local svc_line=$(get_service "$svc_name")
            if [ -n "$svc_line" ]; then
              selected_lines="${selected_lines}${svc_line}\n"
            fi
          done

          # ì„ì‹œ íŒŒì¼ì— ì €ì¥
          echo "$selected" | while IFS= read -r line; do
            local svc_name=$(echo "$line" | cut -d' ' -f1)
            get_service "$svc_name"
          done > /tmp/k8s-pf-selected.$$

          echo ""
          start_selected_services "$(cat /tmp/k8s-pf-selected.$$)"
          rm -f /tmp/k8s-pf-selected.$$
          echo ""
          echo "$(msg press_enter)"
          read
        fi

    elif [[ "$ACTION" == *"$(msg menu_stop)"* ]] || [[ "$ACTION" == "â¹ï¸"* ]]; then
        cleanup
        echo ""
        echo -e "${GREEN}$(msg stopped)${NC}"
        echo ""
        echo "$(msg press_enter)"
        read

    elif [[ "$ACTION" == *"$(msg menu_status)"* ]] || [[ "$ACTION" == "ğŸ“Š"* ]]; then
        echo ""
        echo -e "${BLUE}=== í¬íŠ¸ í¬ì›Œë”© ìƒíƒœ ===${NC}"
        echo ""

        if [ ! -f "$PID_FILE" ]; then
          echo "ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸ í¬ì›Œë”©ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          printf "%-5s %-30s %-15s\n" "PID" "ì„œë¹„ìŠ¤" "ìƒíƒœ"
          echo "-------------------------------------------------------"

          while read pid; do
            if ps -p $pid > /dev/null 2>&1; then
              local cmd=$(ps -p $pid -o args= | grep -o 'svc/[^ ]*' | cut -d'/' -f2)
              echo -e "${GREEN}âœ“${NC} $pid  $cmd  ì‹¤í–‰ ì¤‘"
            else
              echo -e "${RED}âœ—${NC} $pid  ì¢…ë£Œë¨"
            fi
          done < "$PID_FILE"
        fi

        echo ""
        echo "Press Enter to continue..."
        read
        ;;

      "ğŸ“ ì„œë¹„ìŠ¤ ëª©ë¡")
        echo ""
        echo -e "${BLUE}=== ì„¤ì •ëœ ì„œë¹„ìŠ¤ ëª©ë¡ ===${NC}"
        echo ""

        local service_count=$(count_services)
        if [ "$service_count" -eq 0 ]; then
          echo "ë“±ë¡ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
        else
          printf "%-30s %-15s %-10s %-10s\n" "ì„œë¹„ìŠ¤ëª…" "ë„¤ì„ìŠ¤í˜ì´ìŠ¤" "ë¡œì»¬ í¬íŠ¸" "ì›ê²© í¬íŠ¸"
          echo "-----------------------------------------------------------------------"

          while IFS='|' read -r name namespace local_port remote_port; do
            printf "%-30s %-15s %-10s %-10s\n" "$name" "$namespace" "$local_port" "$remote_port"
          done < "$SERVICES_FILE"
        fi

        echo ""
        echo "Press Enter to continue..."
        read
        ;;

      "âš™ï¸  ì„œë¹„ìŠ¤ ê´€ë¦¬")
        # ì„œë¹„ìŠ¤ ê´€ë¦¬ ë£¨í”„
        while true; do
          clear
          echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
          echo -e "${BLUE}â•‘         ì„œë¹„ìŠ¤ ê´€ë¦¬                     â•‘${NC}"
          echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
          echo ""

          local svc_count=$(count_services)
          echo -e "${YELLOW}í˜„ì¬ ë“±ë¡ëœ ì„œë¹„ìŠ¤: ${svc_count}ê°œ${NC}"
          echo ""

          # í˜„ì¬ ì„œë¹„ìŠ¤ ëª©ë¡ í‘œì‹œ
          if [ "$svc_count" -gt 0 ]; then
            printf "%-30s %-15s %-10s\n" "ì„œë¹„ìŠ¤ëª…" "ë„¤ì„ìŠ¤í˜ì´ìŠ¤" "ë¡œì»¬ í¬íŠ¸"
            echo "-------------------------------------------------------"
            while IFS='|' read -r name namespace local_port remote_port; do
              printf "%-30s %-15s %-10s\n" "$name" "$namespace" "$local_port"
            done < "$SERVICES_FILE"
            echo ""
          fi

          SUB_ACTION=$(gum choose \
            "â• ì„œë¹„ìŠ¤ ì¶”ê°€" \
            "â– ì„œë¹„ìŠ¤ ì‚­ì œ (ë‹¤ì¤‘ì„ íƒ)" \
            "âœï¸  í¬íŠ¸ ìˆ˜ì •" \
            "â—€ï¸  ë’¤ë¡œ")

          case "$SUB_ACTION" in
            "â• ì„œë¹„ìŠ¤ ì¶”ê°€")
              echo ""
              echo -e "${BLUE}ìƒˆ ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”:${NC}"
              echo ""

              # ê° í•„ë“œë¥¼ ìˆœì„œëŒ€ë¡œ ì…ë ¥ë°›ê¸°
              echo "ì„œë¹„ìŠ¤ëª…:"
              ADD_SVC=$(gum input --placeholder "ì˜ˆ: my-service-svc")
              INPUT_EXIT=$?

              if [ $INPUT_EXIT -ne 0 ] || [ -z "$ADD_SVC" ]; then
                echo -e "${YELLOW}ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
                sleep 1
                continue
              fi

              # ì¤‘ë³µ ì²´í¬
              if grep -q "^${ADD_SVC}|" "$SERVICES_FILE" 2>/dev/null; then
                echo ""
                echo -e "${RED}âœ— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì„œë¹„ìŠ¤ëª…ì…ë‹ˆë‹¤: $ADD_SVC${NC}"
                echo ""
                sleep 2
                continue
              fi

              echo ""
              echo "ë„¤ì„ìŠ¤í˜ì´ìŠ¤:"
              ADD_NS=$(gum input --placeholder "dev" --value "dev")
              [ -z "$ADD_NS" ] && ADD_NS="dev"

              echo ""
              echo "ë¡œì»¬ í¬íŠ¸:"
              ADD_LOCAL=$(gum input --placeholder "ì˜ˆ: 9999")

              if [ -z "$ADD_LOCAL" ]; then
                echo ""
                echo -e "${RED}âœ— ë¡œì»¬ í¬íŠ¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.${NC}"
                echo ""
                sleep 1
                continue
              fi

              echo ""
              echo "ì›ê²© í¬íŠ¸:"
              ADD_REMOTE=$(gum input --placeholder "9090" --value "9090")
              [ -z "$ADD_REMOTE" ] && ADD_REMOTE="9090"

              # ì…ë ¥ê°’ í™•ì¸
              echo ""
              echo -e "${YELLOW}ì…ë ¥ í™•ì¸:${NC}"
              echo "  ì„œë¹„ìŠ¤ëª…: '$ADD_SVC'"
              echo "  ë„¤ì„ìŠ¤í˜ì´ìŠ¤: '$ADD_NS'"
              echo "  ë¡œì»¬ í¬íŠ¸: '$ADD_LOCAL'"
              echo "  ì›ê²© í¬íŠ¸: '$ADD_REMOTE'"
              echo ""

              # ìµœì¢… í™•ì¸
              if gum confirm "ì´ëŒ€ë¡œ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; then
                # ì„œë¹„ìŠ¤ ì¶”ê°€
                add_service "$ADD_SVC" "$ADD_NS" "$ADD_LOCAL" "$ADD_REMOTE"

                echo ""
                echo -e "${GREEN}âœ“ '$ADD_SVC' ì„œë¹„ìŠ¤ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
                echo "  â””â”€ $ADD_NS:$ADD_LOCAL -> $ADD_REMOTE"
                echo ""

                gum spin --spinner dot --title "ëª©ë¡ ê°±ì‹  ì¤‘..." -- sleep 1
              else
                echo ""
                echo -e "${YELLOW}ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
                sleep 0.5
              fi
              ;;

            "â– ì„œë¹„ìŠ¤ ì‚­ì œ (ë‹¤ì¤‘ì„ íƒ)")
              local svc_count=$(count_services)

              if [ "$svc_count" -eq 0 ]; then
                echo ""
                echo -e "${YELLOW}ì‚­ì œí•  ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.${NC}"
                echo ""
                echo "Press Enter to continue..."
                read
                continue
              fi

              echo ""
              echo -e "${YELLOW}ì‚­ì œí•  ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš” (Spaceë¡œ ì„ íƒ, Enterë¡œ í™•ì¸):${NC}"
              echo ""

              local delete_options=()
              while IFS='|' read -r name namespace local_port remote_port; do
                delete_options+=("$name ($namespace:$local_port)")
              done < "$SERVICES_FILE"

              local to_delete=$(gum choose --no-limit "${delete_options[@]}")

              if [ -n "$to_delete" ]; then
                echo ""
                local delete_count=0

                echo "$to_delete" | while IFS= read -r line; do
                  local svc_name=$(echo "$line" | cut -d' ' -f1)
                  delete_service "$svc_name"
                  echo -e "${GREEN}âœ“${NC} '$svc_name' ì‚­ì œë¨"
                  delete_count=$((delete_count + 1))
                done

                echo ""
                echo -e "${GREEN}âœ“ ì„œë¹„ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
                echo ""
                gum spin --spinner dot --title "ëª©ë¡ ê°±ì‹  ì¤‘..." -- sleep 1
              fi
              ;;

            "âœï¸  í¬íŠ¸ ìˆ˜ì •")
              local svc_count=$(count_services)

              if [ "$svc_count" -eq 0 ]; then
                echo ""
                echo -e "${YELLOW}ìˆ˜ì •í•  ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.${NC}"
                echo ""
                echo "Press Enter to continue..."
                read
                continue
              fi

              echo ""
              echo "ìˆ˜ì •í•  ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”:"
              echo ""

              local edit_options=()
              while IFS='|' read -r name namespace local_port remote_port; do
                edit_options+=("$name ($namespace:$local_port)")
              done < "$SERVICES_FILE"

              local to_edit=$(gum choose "${edit_options[@]}")

              if [ -n "$to_edit" ]; then
                local svc_name=$(echo "$to_edit" | cut -d' ' -f1)
                local svc_info=$(get_service "$svc_name")

                local old_ns=$(echo "$svc_info" | cut -d'|' -f2)
                local old_local=$(echo "$svc_info" | cut -d'|' -f3)
                local old_remote=$(echo "$svc_info" | cut -d'|' -f4)

                echo ""
                echo -e "${BLUE}í˜„ì¬ ì„¤ì •:${NC}"
                echo "  ì„œë¹„ìŠ¤ëª…: $svc_name"
                echo "  ë„¤ì„ìŠ¤í˜ì´ìŠ¤: $old_ns"
                echo "  ë¡œì»¬ í¬íŠ¸: $old_local"
                echo "  ì›ê²© í¬íŠ¸: $old_remote"
                echo ""
                echo -e "${YELLOW}ìƒˆ ê°’ì„ ì…ë ¥í•˜ì„¸ìš” (Enterë§Œ ëˆ„ë¥´ë©´ ê¸°ì¡´ ê°’ ìœ ì§€):${NC}"
                echo ""

                local new_ns=$(gum input --placeholder "ë„¤ì„ìŠ¤í˜ì´ìŠ¤" --value "$old_ns")
                local new_local=$(gum input --placeholder "ë¡œì»¬ í¬íŠ¸" --value "$old_local")
                local new_remote=$(gum input --placeholder "ì›ê²© í¬íŠ¸" --value "$old_remote")

                # ë¹„ì–´ìˆìœ¼ë©´ ê¸°ì¡´ ê°’ ì‚¬ìš©
                [ -z "$new_ns" ] && new_ns="$old_ns"
                [ -z "$new_local" ] && new_local="$old_local"
                [ -z "$new_remote" ] && new_remote="$old_remote"

                update_service "$svc_name" "$new_ns" "$new_local" "$new_remote"

                echo ""
                echo -e "${GREEN}âœ“ '$svc_name' ì„œë¹„ìŠ¤ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
                echo "  â””â”€ $new_ns:$new_local -> $new_remote"
                echo ""
                gum spin --spinner dot --title "ëª©ë¡ ê°±ì‹  ì¤‘..." -- sleep 1
              fi
              ;;

            "â—€ï¸  ë’¤ë¡œ")
              break
              ;;
          esac
        done
        ;;

      "ğŸ“‹ ë¡œê·¸ ë³´ê¸°")
        echo ""
        local log_files=($(ls -1 "$LOG_DIR"/*.log 2>/dev/null))

        if [ ${#log_files[@]} -eq 0 ]; then
          echo "ë¡œê·¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          echo ""
          echo "Press Enter to continue..."
          read
        else
          local log_options=()
          for log in "${log_files[@]}"; do
            log_options+=("$(basename $log)")
          done

          local selected_log=$(gum choose "${log_options[@]}")

          if [ -n "$selected_log" ]; then
            clear
            echo -e "${BLUE}=== $selected_log ===${NC}"
            echo ""
            tail -n 50 "$LOG_DIR/$selected_log"
            echo ""
            echo "Press Enter to continue..."
            read
          fi
        fi
        ;;

      "âŒ ì¢…ë£Œ")
        clear
        echo -e "${GREEN}ğŸ‘‹ ì¢…ë£Œí•©ë‹ˆë‹¤.${NC}"
        exit 0
        ;;
    esac
  done
}

# ê¸°ë³¸ CLI ëª¨ë“œ (gum ì—†ì„ ë•Œ)
cli_mode() {
  echo "==================================="
  echo " K8s Port Forward Manager"
  echo "==================================="
  echo ""
  echo "1. ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘"
  echo "2. ì„œë¹„ìŠ¤ ëª©ë¡"
  echo "3. ëª¨ë‘ ì¤‘ì§€"
  echo "4. ìƒíƒœ í™•ì¸"
  echo "5. ì¢…ë£Œ"
  echo ""
  echo -n "ì„ íƒ (1-5): "
  read -r choice

  case $choice in
    1)
      start_selected_services "$(list_services)"
      ;;
    2)
      echo ""
      printf "%-30s %-15s %-10s\n" "ì„œë¹„ìŠ¤ëª…" "ë„¤ì„ìŠ¤í˜ì´ìŠ¤" "ë¡œì»¬ í¬íŠ¸"
      echo "-------------------------------------------------------"
      while IFS='|' read -r name namespace local_port remote_port; do
        printf "%-30s %-15s %-10s\n" "$name" "$namespace" "$local_port"
      done < "$SERVICES_FILE"
      ;;
    3)
      cleanup
      echo "ëª¨ë“  í¬íŠ¸ í¬ì›Œë”©ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
      ;;
    4)
      echo ""
      echo "ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸ í¬ì›Œë”©:"
      if [ ! -f "$PID_FILE" ]; then
        echo "  ì—†ìŒ"
      else
        while read pid; do
          if ps -p $pid > /dev/null 2>&1; then
            echo "  âœ“ PID $pid ì‹¤í–‰ ì¤‘"
          fi
        done < "$PID_FILE"
      fi
      ;;
    5)
      exit 0
      ;;
  esac
}

# ë©”ì¸
main() {
  case "${1:-ui}" in
    ui)
      if check_gum; then
        gum_ui
      else
        cli_mode
      fi
      ;;
    start)
      shift
      if [ $# -eq 0 ]; then
        start_selected_services "$(list_services)"
      else
        # íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ì‹œì‘
        for svc in "$@"; do
          get_service "$svc"
        done > /tmp/k8s-pf-start.$$
        start_selected_services "$(cat /tmp/k8s-pf-start.$$)"
        rm -f /tmp/k8s-pf-start.$$
      fi
      ;;
    stop)
      cleanup
      echo "ëª¨ë“  í¬íŠ¸ í¬ì›Œë”©ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
      ;;
    status)
      if [ ! -f "$PID_FILE" ]; then
        echo "ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸ í¬ì›Œë”©ì´ ì—†ìŠµë‹ˆë‹¤."
      else
        while read pid; do
          if ps -p $pid > /dev/null 2>&1; then
            local cmd=$(ps -p $pid -o args=)
            echo "âœ“ PID $pid: $cmd"
          fi
        done < "$PID_FILE"
      fi
      ;;
    *)
      echo "Usage: $0 {ui|start [services...]|stop|status}"
      exit 1
      ;;
  esac
}

main "$@"
